---
title: "Bilan des saisies opportunistes - Région Nouvelle-Aquitaine"
author: "OFB DR Nouvelle-Aquitaine - Service régional Connaissance"
date: "`r format(Sys.time(), '%d %B %Y')`"
toc-title: "Sommaire"
output:
  word_document:
    toc: true
    toc_depth : 2
    reference_doc: "reference_doc.docx" # Référence de mise en forme
params:
  annee_fin: 2024
  annee_debut: 2020
  OISON: 'TRUE'  # mettre "TRUE"/"FALSE" pour prendre en compte les données OISON ou non
  PMC: 'TRUE'   # mettre "TRUE"/"FALSE" pour prendre en compte les données PMCC ou non
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE,
                      fig.align = "center",  # figure centrée
                      fig.retina = 4,      # Qualité des figures
                      out.width = "100%",      # remplissage de la largeur
                      dev = 'png',        # Format des figures
                      cache = FALSE)     # Pas d'enregistrement
library(sf)
library(dplyr)
library(tidyverse)
library(tmaptools)
library(ggplot2)
library(ggthemes)
library(ggrepel)
library(gridExtra)
library(fmsb) # radarchart
library(reshape2) # permet de permuter les colonnes et les lignes d'un R.data
library(flextable) # permet de faire des beaux tableaux
library(scales) # format des nombres

colors_esp <- c(
  "Arachnides" = "#E41A1C",      # Rouge vif
  "Autres" = "#984EA3",          # Bleu foncé
  "Reptiles" = "#FF7F00",        # Vert
  "Poissons" = "#00008B",        # Violet foncé
  "Angiospermes" = "#4DAF4A",    # Orange
  "Amphibiens" = "#FFF333",      # Jaune vif
  "Insectes" = "#A65628",        # Brun
  "Mammiferes" = "#F781BF",      # Rose
  "PMC" = "#D8B365",             # Brun clair
  "Crustacés" = "#66DAA0",       # Vert turquoise
  "Oiseaux" = "#3288BD",         # Bleu clair
  "Non spécifié"= "#BBBBBB"      # Gris
)

colors_pmc <- c(
  "Fouine" = "#E63946",                     # Rouge vif
  "Blaireau européen" = "#FFF333",          # Jaune clair
  "Renard roux" = "#F1C40F",                # Jaune doré
  "Belette d'Europe" = "#A8DADC",           # Bleu clair
  "Raton laveur" = "#457B9D",               # Bleu foncé
  "Putois d'Europe" = "#F77F00",            # Orange vif
  "Hermine" = "#D52380",                    # Rose
  "Martre des pins" = "#9D4EDD",            # Violet
  "Chat sauvage" = "#2A9D8F",               # Vert turquoise
  "Castor d'Eurasie" = "#FFAB00"            # Jaune-orange
)

colors_dep <- c(
  "16" = "#FF6F61",   
  "17" = "#3A6EA5",   
  "19" = "#E3B23C",   
  "23" = "#9DBE8C",  
  "24" = "#FF9B85",   
  "33" = "#B0C4DE",   
  "40" = "#F3E000",   
  "47" = "#2C3E50",  
  "64" = "#C17ECF",   
  "79" = "#B2957B",    
  "86" = "#8F5B34",   
  "87" = "#FFF3B4"   
)

colors_statut <- c(
  "envahissante" = "#4E342E",   # Orange
  "menacée" = "#E67E22",        # Vert clair
  "normale" = "#377EB8"      # Bleu clair
)

colors_pro <- c(
  "protégée" = "darkgreen",   # Vert
  "non protégée" = "darkblue"  # Jaune
)

# Ouverture des fichiers utilisés dans le Rmarkdown
OISON_PMC <- st_read("../processed_data/OISON_PMC.gpkg")
departements <- st_read("../processed_data/departements.gpkg")


# Filtrage des données OISON et/ou PMC
nom_bases <- "(OISON + PMCC)"

if(params$OISON=="FALSE"){
  OISON_PMC <- OISON_PMC %>% 
  filter(GROUP2_INPN == "PMC") %>% 
  mutate(GROUP2_INPN = nom_vernaculaire) 
  nom_bases <-  "(PMC)"
  colors_esp <- colors_pmc}

if(params$PMC=="FALSE"){
  OISON_PMC <- OISON_PMC %>% 
  filter(GROUP2_INPN != "PMC")
  nom_bases <-  "(OISON)"}

if(params$PMC=="FALSE" & params$OISON=="FALSE"){
  nom_bases <-  "(AUCUNE BASE DE DONNEE)"}
```

# Introduction

Les données présentées sont issues des bases de données OISON et du réseau-PMCC de l'Office français de la biodiversité (OFB). Elles font ici l'objet d'un suivi sur le nombre de saisies, le nombre d'observateurs, la saisie moyenne par observateur, les groupes d'espèces, leur statut dans les listes rouges ou envahissantes, les espèces protégées en France et leur répartition géographique.

Un observateur est relié au département dans lequel il a le plus saisi.


A propos de OISON :

Depuis toujours les agents de l'OFB sur le terrain réalisent des observations qu'ils peuvent maintenant compiler dans un outil informatique permettant la saisie informatique en mode nomade des observations relatives aux espèces et aux milieux. Les données collectées sont majoritairement le résultat d'observations opportunistes ou fortuites, mais elles peuvent aussi être le résultat de la mise en œuvre de protocoles qui se caractérisent par des formulaires simples (nombre de champs réduits).

A propos du réseau-PMCC :

Le réseau Petits et mésocarnivores (PMC) suit l’évolution de la répartition des populations de 14 espèces de carnivores en France métropolitaine, aux statuts règlementaires et de conservation variés. Les connaissances acquises grâce à ce réseau interne permettent à l’OFB d’apporter une expertise technique et scientifique sur ces espèces à tous les niveaux : départemental, régional, national et européen.

\newpage

# Evolutions sur la saisie `r nom_bases`

## Evolution du nombre de saisies

L'évolution des saisies `r nom_bases` depuis `r params$annee_debut` est présentée dans le tableau ci-dessous. Les départements sont classés selon l'ordre décroissant du nombre de saisies de la dernière année étudiée, ici `r params$annee_fin`. 

```{r}
saisies <- OISON_PMC %>% 
  st_set_geometry(NULL) %>%                          # Supprime la géométrie des données spatiales
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>% # Filtre les années
  group_by(annee, INSEE_DEP) %>%                     # Regroupe les données par année et département
  summarise(nombre_saisies = n())                    # Calcule le nombre de saisies par groupe

saisies_histo <- saisies                             # Copie le dataframe 'saisies'
saisies_histo$annee <- as.factor(saisies_histo$annee) # Transforme la colonne 'annee' en facteur

saisie_derniere_annee <- saisies %>% 
  filter(annee == params$annee_fin) %>%              # Filtre pour l'année spécifiée
  arrange(nombre_saisies) %>%                        # Trie par nombre de saisies
  mutate(pourcentage = round((nombre_saisies / sum(nombre_saisies)) * 100)) %>% # Calcule le pourcentage de chaque département
  mutate(cumulative = pourcentage / 2 + c(0, cumsum(pourcentage)[-length(pourcentage)])) # Calcule le cumul des pourcentages

saisie_derniere_annee$INSEE_DEP <- saisie_derniere_annee$INSEE_DEP %>% 
  factor(levels = rev(saisie_derniere_annee$INSEE_DEP)) # Reclassifie les départements en ordre inverse

saisies$INSEE_DEP <- saisies$INSEE_DEP %>% 
  factor(levels = rev(saisie_derniere_annee$INSEE_DEP)) # Reclassifie les départements selon l'ordre de la dernière année

saisies_histo$INSEE_DEP <- saisies_histo$INSEE_DEP %>% 
  factor(levels = rev(saisie_derniere_annee$INSEE_DEP)) # Reclassifie les départements selon l'ordre de la dernière année

```


```{r , fig.width = 6 , fig.height = 3.5}
# Transformation en tableau croisé dynamique
saisies_tableau <- saisies %>%
  dcast(annee ~ INSEE_DEP, value.var = "nombre_saisies", fill = 0) %>% # transforme en tableau
  mutate(total = rowSums(select(., -annee), na.rm = TRUE)) %>% # calcul les totaux
  mutate(annee = as.character(annee)) # met annee en caractere

# Appliquer le format français aux colonnes appropriées
saisies_tableau <- saisies_tableau %>%
  mutate(across(-annee, ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE)))

cols_numeric <- which(sapply(saisies_tableau, is.numeric))

  
flextable(saisies_tableau) %>%
  set_header_labels( 
    annee = "Année",
    `16` = "16",
    `17` = "17",
    `19` = "19",
    `23` = "23",
    `24` = "24",
    `33` = "33",
    `40` = "40",
    `47` = "47",
    `64` = "64",
    `79` = "79",
    `86` = "86",
    `87` = "87",
    total = "Total"
  ) %>%  # renommer les colonnes
  theme_vanilla() %>%
  color(part = "header", color = "white") %>%
  bg(part = "header", bg = "#333333") %>%
  bold(part = "header") %>% 
  align(j = cols_numeric, align = "right") %>%   # Aligner à droite les colonnes de saisies
  align(part = "header",j = cols_numeric, align = "right") %>% 
  set_caption(caption = paste("Evolution du nombre de saisies par département",nom_bases)) %>%
  autofit()
```



Les mêmes résultats que le tableau mais présentés cette fois ci sous forme de graphique. 


```{r , fig.width = 10 , fig.height = 5}
ggplot(saisies_histo) +
  aes(x = INSEE_DEP, y = nombre_saisies, fill = annee) +
  geom_col(position = "dodge2", color = "black") +
  scale_fill_brewer(palette = "Blues") +
  labs(
    x = "Départements",
    y = "Nombre de saisies",
    fill = "Années",
    title = paste("Evolution du nombre de saisies par département",nom_bases)
  ) +
  theme_minimal()+
  guides(fill = guide_legend(reverse = TRUE)) +
  theme(text = element_text(size = 9))
```


\newpage

## Evolution du nombre d'observateurs

L'évolution du nombre d'observateurs par département est dressée dans le tableau ci-dessous, de `r params$annee_debut` à `r params$annee_fin`. Les départements sont classés par ordre décroissant en fonction de la dernière année étudiée. 

```{r}
observateurs <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  st_set_geometry(NULL) %>% 
  select(annee, INSEE_DEP, Observateur) %>%
  
  # Compter le nombre d'observations par observateur et département
  group_by(annee, INSEE_DEP, Observateur) %>%
  summarise(nombre_observations = n(), .groups = 'drop') %>%
  
  # Trouver le maximum de nombre d'observations par observateur
  group_by(annee, Observateur) %>%
  filter(nombre_observations == max(nombre_observations)) %>%
  ungroup() %>%
  
  # Déduire le département avec le maximum d'observations pour chaque observateur
  group_by(annee, INSEE_DEP) %>%
  summarise(nombre_observateurs = n_distinct(Observateur), .groups = 'drop')

observateurs_histo <- observateurs
observateurs_histo$annee <- as.factor(observateurs_histo$annee)

observateurs_derniere_annee <- observateurs %>% 
  filter(annee == params$annee_fin) %>% 
  arrange(nombre_observateurs) %>% 
  mutate(pourcentage = round((nombre_observateurs / sum(nombre_observateurs)) * 100)) %>% 
  mutate(cumulative = pourcentage / 2 + c(0, cumsum(pourcentage)[-length(pourcentage)]))

observateurs_derniere_annee$INSEE_DEP <- observateurs_derniere_annee$INSEE_DEP %>% 
  factor(levels = rev(observateurs_derniere_annee$INSEE_DEP))

observateurs$INSEE_DEP <- observateurs$INSEE_DEP %>% 
  factor(levels = rev(observateurs_derniere_annee$INSEE_DEP))

observateurs_histo$INSEE_DEP <- observateurs_histo$INSEE_DEP %>% 
  factor(levels = rev(observateurs_derniere_annee$INSEE_DEP))
```



```{r , fig.width = 6 , fig.height = 3.5}
# Transformation en tableau croisé
observateurs_tableau <- observateurs %>%
  dcast(annee ~ INSEE_DEP, value.var = "nombre_observateurs", fill = 0) %>% # transforme en tableau
  mutate(total = rowSums(select(., -annee), na.rm = TRUE)) %>% # calcul les totaux
  mutate(annee = as.character(annee)) # met annee en caractere
  

# Appliquer le format français aux colonnes appropriées
observateurs_tableau <- observateurs_tableau %>%
  mutate(across(-annee, ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE)))

cols_numeric <- which(sapply(observateurs_tableau, is.numeric))

  
flextable(observateurs_tableau) %>%
  set_header_labels(
    annee = "Année",
    `16` = "16",
    `17` = "17",
    `19` = "19",
    `23` = "23",
    `24` = "24",
    `33` = "33",
    `40` = "40",
    `47` = "47",
    `64` = "64",
    `79` = "79",
    `86` = "86",
    `87` = "87",
    total = "Total"
  ) %>%
  theme_vanilla() %>%
  color(part = "header", color = "white") %>%
  bg(part = "header", bg = "#333333") %>%
  bold(part = "header") %>% 
  align(j = cols_numeric, align = "right") %>%   # Aligner à droite les colonnes de saisies
  align(part = "header",j = cols_numeric, align = "right") %>% 
  set_caption(caption = paste("Evolution du nombre d'observateurs par département",nom_bases)) %>%
  autofit()

# Déterminer le top 5 des départements selon la dernière année
top_dep <- observateurs %>%
  filter(annee == params$annee_fin) %>%
  arrange(desc(nombre_observateurs)) %>%
  slice_head(n = 5) %>%
  pull(INSEE_DEP)
```

Représentation graphique de cette évolution avec un focus sur les 5 départements (`r top_dep`) ayant le plus d'observateurs en `r params$annee_fin`.

```{r , fig.width = 8 , fig.height = 5}
# Graphique général
p_all <- ggplot(filter(observateurs, !is.na(INSEE_DEP))) +
  aes(x = annee, y = nombre_observateurs, color = INSEE_DEP, group = INSEE_DEP) +
  geom_line(linewidth = 0.8, alpha = 0.6) +
  geom_point(size = 1.5, alpha = 0.7) +
  scale_fill_manual(values = colors_dep) +
  labs(
    x = NULL,
    y = "Nombre d'observateurs",
    color = "Départements",
    title = "Évolution du nombre d'observateurs par département"
  ) +
  theme_minimal(base_size = 9) +
  theme(axis.text.y = element_text(size = 7),
        axis.title.y = element_text(size = 6),
        legend.position = "bottom",
        legend.direction = "horizontal",
        legend.box = "horizontal")



# Graphique du Top 5
p_top5 <- ggplot(filter(observateurs, INSEE_DEP %in% top_dep)) +
  aes(x = annee, y = nombre_observateurs, color = INSEE_DEP, group = INSEE_DEP) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  scale_fill_manual(values = colors_dep) +
  labs(
    x = NULL,
    y = "Nombre d'observateurs",
    color = "Départements",
    title = paste("Zoom sur le Top 5 des départements (", params$annee_fin, ")", sep = "")
  ) +
  theme_minimal(base_size = 9) +
  theme(
    legend.position = "right",
    axis.text.y = element_text(size = 7),
    axis.title.y = element_text(size = 6),
    axis.ticks.y = element_blank(),
    plot.title = element_text(size = 9)
  )

# Assemblage et combinaison des deux graphiques
(p_all / p_top5) + plot_layout(widths = c(2, 1))

```


\newpage

## Evolution du nombre moyen de saisie par observateur

L'évolution du nombre moyen de saisie par observateur, de `r params$annee_debut` à `r params$annee_fin`, par département, est présentée dans le tableau ci-dessous. Les départements sont rangés par ordre décroissant en fonction de leur moyenne sur la dernière année étudiée.

```{r}
saisies_observateur <- saisies %>%
  left_join(observateurs) %>%
  mutate(moyenne_saisies_observateur =
           ifelse(!is.na(nombre_observateurs)
                  & nombre_observateurs > 0, 
                  nombre_saisies / nombre_observateurs, 
                  0)) %>% 
  select(annee,INSEE_DEP,moyenne_saisies_observateur)
  
saisies_observateur_histo <- Observateursaisies_observateur_histo <- saisies_observateur
saisies_observateur_histo$annee <- as.factor(saisies_observateur_histo$annee)

saisies_observateur_derniere_annee <- saisies_observateur %>%
  filter(annee == params$annee_fin) %>%
  arrange(moyenne_saisies_observateur)

saisies_observateur$INSEE_DEP <- saisies_observateur$INSEE_DEP %>% 
  factor(levels = rev(saisies_observateur_derniere_annee$INSEE_DEP))

saisies_observateur_histo$INSEE_DEP <- saisies_observateur_histo$INSEE_DEP %>% 
  factor(levels = rev(saisies_observateur_derniere_annee$INSEE_DEP))

```


```{r , fig.width = 6 , fig.height = 3.5}
# Calcul les moyennes totales
saisies_observateur_moy <- OISON_PMC %>%
  group_by(annee, Observateur) %>%
  summarise(nombre_saisies = n()) %>%
  group_by(annee) %>%
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  summarise(moyenne_saisies_observateur = round(mean(nombre_saisies),1)) %>% 
  st_set_geometry(NULL)

# Transformation en tableau croisé dynamique
saisies_observateur_tableau <- saisies_observateur %>%
  mutate(moyenne_saisies_observateur=round(moyenne_saisies_observateur,1)) %>%  # arrondi les moyennes
  dcast(annee ~ INSEE_DEP, value.var = "moyenne_saisies_observateur", fill = 1) %>% # transforme en tableau
  mutate(moyenne=saisies_observateur_moy$moyenne_saisies_observateur) %>%  # ajoute les moyennes totales
  mutate(annee = as.character(annee)) # met annee en caractere

# Appliquer le format français aux colonnes appropriées
saisies_observateur_tableau <- saisies_observateur_tableau %>%
  mutate(across(-annee, ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE)))

cols_numeric <- which(sapply(saisies_observateur_tableau, is.numeric))

  
flextable(saisies_observateur_tableau) %>%
  set_header_labels(
   annee = "Année",
    `16` = "16",
    `17` = "17",
    `19` = "19",
    `23` = "23",
    `24` = "24",
    `33` = "33",
    `40` = "40",
    `47` = "47",
    `64` = "64",
    `79` = "79",
    `86` = "86",
    `87` = "87",
    moyenne = "Moyenne"
  ) %>%
  theme_vanilla() %>%
  color(part = "header", color = "white") %>%
  bg(part = "header", bg = "#333333") %>%
  bold(part = "header") %>% 
  align(j = cols_numeric, align = "right") %>%   # Aligner à droite les colonnes de saisies
  align(part = "header",j = cols_numeric, align = "right") %>% 
  set_caption(caption = paste("Evolution du nombre moyen de saisie par observateur par département",nom_bases)) %>%
  autofit()
```

Les résultats de ce tableau sont illustrés par le graphique ci-dessous.

```{r}
saisies_observateur_violon <- OISON_PMC %>%
  group_by(annee, INSEE_DEP, Observateur) %>%
  summarise(nombre_saisies = n()) %>%
  filter(annee == params$annee_fin)

saisies_observateur_violon$INSEE_DEP <- saisies_observateur_violon$INSEE_DEP %>% 
  factor(levels = rev(saisies_observateur_derniere_annee$INSEE_DEP))
```

```{r , fig.width = 10 , fig.height = 6.5}
ggplot(saisies_observateur_violon, aes(x = INSEE_DEP, y = nombre_saisies, fill=INSEE_DEP)) +
  geom_violin(color = "black") +
  scale_fill_manual(values = colors_dep) +
  stat_summary(fun = mean, geom = "point", shape = 18, size = 3, color = "red", fill="red") +
  stat_summary(fun = median, geom = "crossbar", width = 0.3, size = 0.6, color = "black",fill="black") +
  labs(
    x = "Départements",
    y = "Nombre de saisies par observateur",
    title = paste("Répartition du nombre de saisie par observateur en",params$annee_fin, nom_bases),
    caption="Explications :
    - Pour un nombre de saisie donné, plus la zone est large, plus il y a d'observateurs
    - Le trait noir représente la médiane
    - Le losange rouge représente la moyenne"
  ) +
  theme_minimal()+
  theme(plot.caption = element_text(hjust = 0, size = 10, margin = margin(t = 10)),
        text = element_text(size = 9),
        legend.position = "none")
```

\newpage

# Evolution sur les espèces

## Evolution du nombre régional de saisies par groupe d'espèces

L'évolution du nombre régional de saisies par groupes d'espèces est représentée par le graphique ci-dessous. Les données s'étendent de `r params$annee_debut` à `r params$annee_fin`. 
```{r}
groupes_espece_par_annee <- OISON_PMC %>% 
 filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  filter(GROUP2_INPN != "Non spécifié") %>% 
  group_by(annee,GROUP2_INPN) %>% 
  summarise(nb_saisies = n()) %>% 
  st_set_geometry(NULL) %>% 
  arrange(desc(nb_saisies))

# Ordre des espèces dans la légende décroissante
groupes_espece_par_annee$GROUP2_INPN <- factor(groupes_espece_par_annee$GROUP2_INPN, 
                                               levels = unique(groupes_espece_par_annee$GROUP2_INPN))
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(groupes_espece_par_annee) +
  aes(x = annee, y = nb_saisies, colour = GROUP2_INPN) +
  geom_smooth(se = FALSE) +
  geom_point()+
  scale_colour_manual(values = colors_esp) +
  labs(x = "Années",
       y = "Nombre de saisies",
       colour = "Groupes d'espèces",
       title = paste("Evolution du nombre régional de saisies par groupe d'espèces",nom_bases)) +
  theme_minimal() +
  theme(text = element_text(size = 9))
```

Le graphique suivant analyse ces données selon un point de vue différent, celui des proportions. Le jeu de données utilisé est identique, de `r params$annee_debut` à `r params$annee_fin`. 


```{r}
groupes_espece <- OISON_PMC %>% 
  group_by(GROUP2_INPN) %>% 
  filter(annee==params$annee_fin) %>% 
  summarise(nb_saisies = n()) %>% 
  st_set_geometry(NULL) %>% 
  arrange(nb_saisies) %>% 
  mutate(pourcentage = round((nb_saisies / sum(nb_saisies)) * 100)) %>% 
  mutate(cumulative = pourcentage / 2 + c(0, cumsum(pourcentage)[-length(pourcentage)]))
  
# Ordre des espèces décoissant  
groupes_espece$GROUP2_INPN <- groupes_espece$GROUP2_INPN %>% 
  factor(levels = rev(groupes_espece$GROUP2_INPN))
```

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(groupes_espece)+
  aes(x = factor(1), y = pourcentage, fill = GROUP2_INPN) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar(theta = "y")+
  theme_void()+
  scale_fill_manual(values = colors_esp) +
  geom_text(data=tail(groupes_espece,3),
            aes(x = 1.8, 
                y = cumulative, 
                label=paste0(GROUP2_INPN, "\n (",pourcentage, "%)")),
                size = 3)+
  labs(
    title = paste("Proportions du nombre régional de saisies par groupe d'espèce en",params$annee_fin,nom_bases),
    fill = "Groupes d'espèces"
    ) +
  theme(
    text = element_text(size = 9),
    plot.title = element_text(hjust = 0.2),  # Aligne le titre à gauche
    legend.margin = margin(t = 0, r = 0, b = 0, l = 50),  # Espace à gauche de la légende
    plot.margin = margin(t = 1, r = 1, b = 1, l = 1)
  )
```

\newpage

```{r}
groupes_espece_dep <- OISON_PMC %>% 
  group_by(GROUP2_INPN,INSEE_DEP) %>% 
  filter(annee==params$annee_fin) %>% 
  summarise(nb_saisies = n()) %>% 
  st_set_geometry(NULL) 

# Transformation en tableau croisé
groupes_espece_tableau <- OISON_PMC %>% 
  group_by(GROUP2_INPN) %>% 
  filter(annee==params$annee_fin) %>% 
  summarise(nb_saisies = n()) %>% 
  st_set_geometry(NULL) %>% 
  mutate(INSEE_DEP="Région") %>% 
  bind_rows(groupes_espece_dep) %>% 
  dcast(GROUP2_INPN ~ INSEE_DEP, value.var = "nb_saisies", fill = 0)

# Calcul de la ligne "Total" et des pourcentages
totaux <- groupes_espece_tableau %>%
  summarise(across(where(is.numeric), sum, na.rm = TRUE)) %>%
  mutate(GROUP2_INPN = "Total")
  
groupes_espece_tableau <- groupes_espece_tableau %>% 
  bind_rows(totaux) %>% 
  arrange(Région) %>% 
  mutate(across(-GROUP2_INPN,
                ~ . / totaux[[cur_column()]],
                .names = "pourc_{.col}")) %>% 
  mutate(across(starts_with("pourc_"),
                ~ percent(., big.mark = " ", decimal.mark = ",", accuracy = 1))) %>% 
  mutate(across(-GROUP2_INPN,
                ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE))) %>% 
  relocate(pourc_16,.after="16") %>% 
  relocate(pourc_17,.after="17") %>% 
  relocate(pourc_19,.after="19") %>% 
  relocate(pourc_23,.after="23") %>% 
  relocate(pourc_24,.after="24") %>%
  relocate(pourc_33,.after="33") %>% 
  relocate(pourc_40,.after="40") %>% 
  relocate(pourc_47,.after="47") %>% 
  relocate(pourc_64,.after="64") %>% 
  relocate(pourc_79,.after="79") %>%
  relocate(pourc_86,.after="86") %>% 
  relocate(pourc_87,.after="87") 
```

```{r , fig.width = 6 , fig.height = 3.5}
groupes_espece_tableau_region <- groupes_espece_tableau %>%
  dplyr::select(GROUP2_INPN, 
                Région,
                pourc_Région)

cols_numeric <- which(sapply(groupes_espece_tableau_region, is.numeric))

flextable(groupes_espece_tableau_region) %>%
  set_header_labels(
    GROUP2_INPN = "Groupes d'espèce",
    Région = "Nombre de saisies",
    pourc_Région = "%"
  ) %>%
  theme_vanilla() %>%
  color(part = "header", color = "white") %>%
  bg(part = "header", bg = "#333333") %>%
  bold(part = "header") %>% 
  fontsize(part="all",j = cols_numeric,size=8) %>%
  font(fontname = "Arial") %>%
  bg(i=nrow(groupes_espece_tableau), bg = "#DDDDDD") %>%
  align(j = cols_numeric, align = "right") %>%   # Aligner à droite les colonnes de saisies
  align(part = "header",j = cols_numeric, align = "right") %>% 
  set_caption(caption = paste("Nombre de saisies par groupe d'espèces au niveau régional en", params$annee_fin ,nom_bases)) %>% 
  set_table_properties(width = 0.8, layout = "autofit") %>%
  width(width = 0.5) # ajuste la largeur des colonnes automatiquement, si ne convient pas utiliser "width(width = 0.5)"
```

```{r, results='asis'}
# Condition pour afficher le titre
if (params$OISON) {
  cat("\\newpage\n")
  cat("## Evolution du nombre régional de saisies par groupe d'espèces hors oiseaux\n")
}
```
Pour mieux voir les groupes d'espèces, autres que "Oiseaux", il est préférable de faire l'analyse sans ce dernier.

```{r}
if (params$OISON) {
  groupes_espece_par_annee_sans_oiseaux <- OISON_PMC %>% 
    group_by(annee, GROUP2_INPN) %>% 
    filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
    filter(GROUP2_INPN != "Oiseaux") %>%
    filter(GROUP2_INPN != "Non spécifié") %>%
    summarise(nb_saisies = n()) %>% 
    st_set_geometry(NULL) %>% 
    arrange(desc(nb_saisies))

  # Ordre des espèces dans la légende décroissante
  groupes_espece_par_annee_sans_oiseaux$GROUP2_INPN <- factor(
    groupes_espece_par_annee_sans_oiseaux$GROUP2_INPN, 
    levels = unique(groupes_espece_par_annee_sans_oiseaux$GROUP2_INPN)
  )
}
```

```{r , fig.width = 6.5 , fig.height = 3.5}
if (params$OISON) {
  ggplot(groupes_espece_par_annee_sans_oiseaux) +
    aes(x = annee, y = nb_saisies, colour = GROUP2_INPN) +
    geom_smooth(se = FALSE) +
    geom_point() +
    scale_colour_manual(values = colors_esp) +
    labs(x = "Années",
         y = "Nombre de saisies",
         colour = "Groupes d'espèce",
         title = paste("Evolution du nombre régional de saisies par groupe d'espèces hors oiseaux", nom_bases)) +
    theme_minimal() +
    theme(
      text = element_text(size = 9),
      plot.title = element_text(size = 10)  # Ajuste la taille du titre ici
    )
}
```

```{r}
if (params$OISON) {
  groupes_espece_sans_oiseaux <- OISON_PMC %>% 
    group_by(GROUP2_INPN) %>% 
    filter(annee == params$annee_fin) %>%
    filter(GROUP2_INPN != "Oiseaux") %>%
    summarise(nb_saisies = n()) %>% 
    st_set_geometry(NULL) %>% 
    arrange(nb_saisies) %>% 
    mutate(pourcentage = round((nb_saisies / sum(nb_saisies)) * 100)) %>% 
    mutate(cumulative = pourcentage / 2 + c(0, cumsum(pourcentage)[-length(pourcentage)]))

  # Ordre des espèces décroissant  
  groupes_espece_sans_oiseaux$GROUP2_INPN <- groupes_espece_sans_oiseaux$GROUP2_INPN %>% 
    factor(levels = rev(groupes_espece_sans_oiseaux$GROUP2_INPN))
}
```
Représentation graphique des différentes proportions des groupes d'espèces saisis, hors "Oiseaux", pour l'année `r params$annee_fin`.


```{r , fig.width = 6.5 , fig.height = 3.5}
if (params$OISON) {
  ggplot(groupes_espece_sans_oiseaux) +
    aes(x = factor(1), y = pourcentage, fill = GROUP2_INPN) +
    geom_bar(width = 1, stat = "identity", color = "white") +
    coord_polar(theta = "y") +
    theme_void() +
    scale_fill_manual(values = colors_esp) +
    
    geom_text(data = tail(groupes_espece_sans_oiseaux, 5),
              aes(x = 1.9, 
                  y = cumulative, 
                  label = paste(GROUP2_INPN, "\n", pourcentage, "%")),
                  size = 3) +
    labs(
      fill = "Groupes d'espèce",
      title = paste("Proportions du nombre régional de saisies par groupe d'espèces hors oiseaux en", params$annee_fin, nom_bases)
    ) +
  theme(
    text = element_text(size = 9),
    plot.title = element_text(hjust = 0.2, size = 9),  # Aligne le titre à gauche et change la taille
    legend.margin = margin(t = 0, r = 0, b = 0, l = 50),  # Espace à gauche de la légende
    plot.margin = margin(t = 1, r = 3, b = 1, l = 3)
  )
}
```

## Répartition des saisies d'espèces hors oiseaux par département
Graphiques radars sur les proportions (%) d'espèces saisies, hors oiseaux de `r params$annee_debut` à `r params$annee_fin`.
```{r}
# Fonction pour créer des graphiques radars (library(fmsb))
create_beautiful_radarchart <- function(
    data, color = "#00AFBB", 
    vlabels = colnames(data), 
    vlcex = NULL,
    caxislabels = NULL, 
    title = NULL, 
    plwd = 2,
    label_offset = 1.25,
    ...){
  
# Taille automatique des labels en fonction du nombre de variables
  if (is.null(vlcex)) {
    nvars <- ncol(data)
    vlcex <- max(0.4, 1.2 - nvars * 0.03)   # diminution progressive
}
  
# Réglage des marges
par(mar = c(1, 1, 1.5, 1))  

radarchart(
    data, 
    axistype = 1,
    
# Personnaliser le polygone
pcol = color, 
pfcol = scales::alpha(color, 0.5), 
plwd = 2, plty = 1,
    
# Personnaliser la grille
cglcol = "grey70", 
cglty = 1, 
cglwd = 0.8,
    
# Personnaliser l'axe
axislabcol = "grey40", 
  
# Étiquettes des variables
vlcex = vlcex, 
vlabels = vlabels,
seg = 5,
caxislabels = caxislabels, 
title = title, ...
  )

# Rotation & reposition d’étiquettes : hack fmsb
# On dessine des labels en dehors, à une distance plus grande
angles <- seq(0, 2*pi, length.out = length(vlabels) + 1)[-1]

r <- max(data[1, ]) * label_offset

  for (i in seq_along(vlabels)) {
    x <- r * sin(angles[i])
    y <- r * cos(angles[i])
    text(x, y, labels = vlabels[i], cex = vlcex, xpd = TRUE)
  }

}
```

```{r}
# Filtrage et regroupement des données
radar_especes_dep <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  filter(GROUP2_INPN != "Oiseaux") %>% 
  filter(GROUP2_INPN != "Non spécifié") %>% 
  group_by(GROUP2_INPN, INSEE_DEP) %>% 
  summarise(nb_saisies = n(), .groups = 'drop') %>% 
  st_set_geometry(NULL)

# Calcul des totaux par département
totaux2 <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  filter(GROUP2_INPN != "Oiseaux") %>% 
  group_by(INSEE_DEP) %>% 
  st_set_geometry(NULL) %>% 
  summarise(total = n(), .groups = 'drop')

# Fusionner les deux tables
radar_especes_dep <- radar_especes_dep %>% 
  left_join(totaux2, by = "INSEE_DEP") %>%
  mutate(pourcentage = round((nb_saisies / total )*100,0))

radar_especes_dep <- radar_especes_dep %>%
  dcast(INSEE_DEP ~ GROUP2_INPN, value.var = "pourcentage", fill = 0)

# Combine max/min with the radar data
radar_especes_dep <- rbind(rep(100,ncol(radar_especes_dep)),rep(0,ncol(radar_especes_dep)), radar_especes_dep)
```

```{r , fig.width = 14 , fig.height = 14}
# Réduire la marge du graphique à l'aide de par()
# Diviser l'écran en 3 parties
op <- par(mfrow = c(2,2), mar = c(1,1,2,1))

for(i in 1:12){

  create_beautiful_radarchart(
    vlcex = 1,
    color = colors_dep[radar_especes_dep$INSEE_DEP[i+2]],
    data = dplyr::select(radar_especes_dep[c(1, 2, i + 2), ], -INSEE_DEP),
    caxislabels = seq(0, 100, length.out = 6),
    label_offset = 1.4,   # plus de marge 
    title = radar_especes_dep$INSEE_DEP[i+2]
  )
}

par(op)

# Créer un pdf regroupant tous les graphiques radars, un par page et par département
#pdf("radars_departements.pdf", width = 8, height = 8)

#for(i in 1:12){
#create_beautiful_radarchart(
#    color = colors_dep[radar_especes_dep$INSEE_DEP[i+2]],
#    data = dplyr::select(radar_especes_dep[c(1, 2, i + 2), ], -INSEE_DEP),
#    caxislabels = seq(0,100,length.out = 6),
#    title = paste("Département", radar_especes_dep$INSEE_DEP[i+2])
#  )
#}

#dev.off()



```

\newpage

# Evolution des saisies d'espèces menacées et envahissantes

## Evolution du nombre régional de saisies par statut
L'évolution du nombre régional de saisies par statut est présentée dans le tableau ci-dessous, pour les années `r params$annee_debut` à `r params$annee_fin`. Les statuts sont fonction de :


- normale : espèces classées "autres catégories" dans les listes rouges nationales


- menacée : espèces des catégories "RE", "EN", "VU", "CR", "CR*", des listes rouges nationales et régionales


- envahissante : liste nationale des espèces classées "envahissantes"
```{r}
statuts_espece_par_annee <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  st_set_geometry(NULL) %>% 
  filter(!is.na(statut_LR)) %>% 
  group_by(annee,statut_LR) %>% 
  summarise(nb_saisies = n()) %>% 
  arrange(desc(nb_saisies))

# Ordre des espèces dans la légende décroissante
statuts_espece_par_annee$statut_LR <- factor(statuts_espece_par_annee$statut_LR, 
                                               levels = unique(statuts_espece_par_annee$statut_LR))
```
```{r , fig.width = 6 , fig.height = 3.5}
# Transformation en tableau croisé dynamique
statuts_espece_par_annee_tableau <- statuts_espece_par_annee %>%
  dcast(annee ~ statut_LR, value.var = "nb_saisies", fill = 0) %>% # transforme en tableau
  mutate(total = rowSums(select(., -annee), na.rm = TRUE)) %>% # calcul les totaux
  mutate(annee = as.character(annee)) # met annee en caractere

# Appliquer le format français aux colonnes appropriées
statuts_espece_par_annee_tableau <- statuts_espece_par_annee_tableau %>%
  mutate(across(-annee, ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE)))

cols_numeric <- which(sapply(statuts_espece_par_annee_tableau, is.numeric))

  
flextable(statuts_espece_par_annee_tableau) %>%
  set_header_labels(
    annee = "Année",
    total = "Total"
  ) %>%
  theme_vanilla() %>%
  color(part = "header", color = "white") %>%
  bg(part = "header", bg = "#333333") %>%
  bold(part = "header") %>% 
  align(j = cols_numeric, align = "right") %>%   # Aligner à droite les colonnes de saisies
  align(part = "header",j = cols_numeric, align = "right") %>% 
  set_caption(caption = paste("Evolution du nombre régional de saisies par statut" ,nom_bases)) %>% 
  set_table_properties(width = 0.8, layout = "autofit") %>%
  autofit()
```


Cette évolution est également représentée par le graphique ci-dessous, de `r params$annee_debut` à `r params$annee_fin`.

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(statuts_espece_par_annee) +
  aes(x = annee, y = nb_saisies, colour = statut_LR) +
  geom_smooth(se = FALSE) +
  geom_point() +
  scale_colour_manual(values = colors_statut) +
  labs(x = "Années",
       y = "Nombre de saisies",
       colour = "Statuts",
       title = paste("Evolution du nombre régional de saisies par statut", nom_bases)) +
  theme_minimal() +
  theme(text = element_text(size = 9))

```

```{r , fig.width = 6.5 , fig.height = 3.5}
statuts_espece <- OISON_PMC %>% 
  st_set_geometry(NULL) %>% 
  filter(annee==params$annee_fin) %>% 
  filter(!is.na(statut_LR)) %>% 
  group_by(statut_LR) %>% 
  summarise(nb_saisies = n()) %>% 
  arrange(nb_saisies) %>% 
  mutate(pourcentage = round((nb_saisies / sum(nb_saisies)) * 100)) %>% 
  mutate(cumulative = pourcentage / 2 + c(0, cumsum(pourcentage)[-length(pourcentage)]))

# Ordre des espèces décoissant  
statuts_espece$statut_LR <- statuts_espece$statut_LR %>% 
  factor(levels = rev(statuts_espece$statut_LR))
```

```{r , fig.width = 6.5 , fig.height = 3.5}
statuts_espece_dep <- OISON_PMC %>% 
  filter(annee==params$annee_fin) %>% 
  filter(!is.na(statut_LR))

ggplot(statuts_espece_dep) +
  aes(x = INSEE_DEP, fill = statut_LR) +
  geom_bar(position = "dodge2") +
  scale_fill_manual(values = colors_statut) +
  labs(
    x = "Départements",
    y = "Nombre de saisies",
    fill = "Statuts",
    title = paste("Nombre de saisies par département et statut en", params$annee_fin, nom_bases)) +
  theme_minimal() +
  theme(text = element_text(size = 9))
```

\newpage

# Evolution des saisies d'espèces protégées
L'évolution des saisies d'espèces protégées est présentée dans le tableau ci-dessous, données de `r params$annee_debut` à `r params$annee_fin`.
```{r}
espece_pro_par_annee <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  st_set_geometry(NULL) %>% 
  group_by(annee,espece_pro) %>% 
  summarise(nb_saisies = n()) %>% 
  arrange(desc(nb_saisies))

# Ordre des espèces dans la légende décroissante
espece_pro_par_annee$espece_pro <- factor(espece_pro_par_annee$espece_pro, 
                                               levels = unique(espece_pro_par_annee$espece_pro))
```


```{r , fig.width = 6 , fig.height = 3.5}
# Transformation en tableau croisé dynamique
espece_pro_par_annee_tableau <- espece_pro_par_annee %>%
  dcast(annee ~ espece_pro, value.var = "nb_saisies", fill = 0) %>% # transforme en tableau
  mutate(total = rowSums(select(., -annee), na.rm = TRUE)) %>% # calcul les totaux
  mutate(annee = as.character(annee)) # met annee en caractere

# Appliquer le format français aux colonnes appropriées
espece_pro_par_annee_tableau <- espece_pro_par_annee_tableau %>%
  mutate(across(-annee, ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE)))

cols_numeric <- which(sapply(espece_pro_par_annee_tableau, is.numeric))

  
flextable(espece_pro_par_annee_tableau) %>%
  set_header_labels(
    annee = "Année",
    total = "Total"
  ) %>%
  theme_vanilla() %>%
  color(part = "header", color = "white") %>%
  bg(part = "header", bg = "#333333") %>%
  bold(part = "header") %>% 
  align(j = cols_numeric, align = "right") %>%   # Aligner à droite les colonnes de saisies
  align(part = "header",j = cols_numeric, align = "right") %>% 
  set_caption(caption = paste("Evolution du nombre régional de saisies d'espèces protégées" ,nom_bases)) %>% 
  set_table_properties(width = 0.8, layout = "autofit") %>%
  autofit()
```


```{r}
groupes_espece_pro_dep <- OISON_PMC %>% 
  group_by(GROUP2_INPN,INSEE_DEP) %>% 
  filter(annee==params$annee_fin) %>% 
  filter(espece_pro=="protégée") %>% 
  summarise(nb_saisies = n()) %>% 
  st_set_geometry(NULL) 

# Transformation en tableau croisé
groupes_espece_pro_tableau <- OISON_PMC %>% 
  group_by(GROUP2_INPN) %>% 
  filter(annee==params$annee_fin) %>% 
  filter(espece_pro=="protégée") %>%
  summarise(nb_saisies = n()) %>% 
  st_set_geometry(NULL) %>% 
  mutate(INSEE_DEP="Région") %>% 
  bind_rows(groupes_espece_pro_dep) %>% 
  dcast(GROUP2_INPN ~ INSEE_DEP, value.var = "nb_saisies", fill = 0)

# Calcul de la ligne "Total"
totaux <- groupes_espece_pro_tableau %>%
  summarise(across(where(is.numeric), sum, na.rm = TRUE)) %>%
  mutate(GROUP2_INPN = "Total")
  
groupes_espece_pro_tableau <- groupes_espece_pro_tableau %>%
  bind_rows(totaux)

# Calcul des pourcentages
num_cols <- names(groupes_espece_pro_tableau)[sapply(groupes_espece_pro_tableau, is.numeric)]

groupes_espece_pro_tableau <- groupes_espece_pro_tableau %>%
  mutate(across(all_of(num_cols), ~ . / totaux[[cur_column()]], .names = "pourc_{.col}")) %>%
  mutate(across(starts_with("pourc_"), ~ scales::percent(., big.mark = " ", decimal.mark = ",", accuracy = 1))) %>%
  mutate(across(all_of(num_cols), ~ format(., big.mark = " ", decimal.mark = ",", scientific = FALSE, trim = TRUE)))

# Relocalisation des colonnes de pourcentage après le département correspondant
deps <- num_cols  # colonnes numériques originales (ex: "16", "17", "19", ...)
for(dep in deps){
  pourc_col <- paste0("pourc_", dep)
  
  if(pourc_col %in% names(groupes_espece_pro_tableau) & dep %in% names(groupes_espece_pro_tableau)){
    groupes_espece_pro_tableau <- groupes_espece_pro_tableau %>%
      relocate(all_of(pourc_col), .after = all_of(dep))
  }
}


```

L'évolution des saisies d'espèces protégées, au niveau régional, en fonction des différents groupes d'espèces, de `r params$annee_fin`.

```{r , fig.width = 6 , fig.height = 3.5}
# Identifier automatiquement les colonnes numériques (ou à aligner)
groupes_espece_pro_tableau_region <- groupes_espece_pro_tableau %>%
  select(GROUP2_INPN,
         Région,
         pourc_Région)

cols_numeric <- which(sapply(groupes_espece_pro_tableau_region, is.numeric))


  
flextable(groupes_espece_pro_tableau_region) %>%
  set_header_labels(
   GROUP2_INPN = "Groupes d'espèces protégées",
   Région = "Nombre de saisies",
   pourc_Région = "%"
  ) %>%
  theme_vanilla() %>%
  color(part = "header", color = "white") %>%
  bg(part = "header", bg = "#333333") %>%
  bold(part = "header") %>% 
  fontsize(part="all",j = cols_numeric,size=8) %>%
  bg(i=nrow(groupes_espece_pro_tableau), bg = "#DDDDDD") %>%
  align(j = cols_numeric, align = "right") %>%   # Aligner à droite les colonnes de saisies
  align(part = "header",j = cols_numeric, align = "right") %>% 
  set_caption(caption = paste("Nombre de saisies régionales par groupe d'espèces protégées en", params$annee_fin ,nom_bases)) %>% 
  set_table_properties(width = 0.8, layout = "autofit") %>%
  autofit()
```

L'évolution du nombre de saisies régionales des espèces protégées est représentée par le graphique ci-dessous, de `r params$annee_debut` à `r params$annee_fin`.

```{r , fig.width = 6.5 , fig.height = 3.5}
ggplot(espece_pro_par_annee) +
  aes(x = annee, y = nb_saisies, colour = espece_pro) +
  geom_smooth(se = FALSE) +
  geom_point()+
  scale_colour_manual(values = colors_pro) +
  labs(x = "Années",
       y = "Nombre de saisies",
       colour = "Réglementation",
       title = paste("Evolution du nombre régional de saisies des espèces protégées", nom_bases)) +
  theme_minimal() +
  theme(text = element_text(size = 9))
```

```{r , fig.width = 6.5 , fig.height = 3.5}
espece_pro <- OISON_PMC %>% 
  st_set_geometry(NULL) %>% 
  filter(annee==params$annee_fin) %>% 
  group_by(espece_pro) %>% 
  summarise(nb_saisies = n()) %>% 
  arrange(nb_saisies) %>% 
  mutate(pourcentage = round((nb_saisies / sum(nb_saisies)) * 100)) %>% 
  mutate(cumulative = pourcentage / 2 + c(0, cumsum(pourcentage)[-length(pourcentage)]))

# Ordre des espèces décoissant  
espece_pro$espece_pro <- espece_pro$espece_pro %>% 
  factor(levels = rev(espece_pro$espece_pro))
```



```{r , fig.width = 6.5 , fig.height = 3.5}
espece_pro_dep <- OISON_PMC %>% 
  filter(annee==params$annee_fin) %>% 
  filter(!is.na(espece_pro))

ggplot(espece_pro_dep) +
  aes(x = INSEE_DEP, fill = espece_pro) +
  geom_bar(position = "dodge2") +
  scale_fill_manual(values = colors_pro) +
  labs(
    x = "Départements",
    y = "Nombre de saisies",
    fill = "Réglementation",
    title = paste("Nombre de saisie par statut réglementaire et par département en", params$annee_fin, nom_bases)) +
  theme_minimal() +
  theme(text = element_text(size = 9))
```

\newpage

# Représentations cartographiques

Les différentes cartes présentées par la suite sont établies à partir des données `r nom_bases` de `r params$annee_debut` à `r params$annee_fin`.

## Représentation des saisies

```{r}
observations_chaleur <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin)
```

```{r , fig.width = 6.5 , fig.height = 4}
ggplot(observations_chaleur) +
  geom_sf(aes(geometry = geom), lwd = 0.5, color = "red",alpha=0.2, size=1.5, shape = 19)+
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5)+
  labs(title=paste("Carte de chaleur : Représentation des saisies \nde",params$annee_debut,"à",params$annee_fin,nom_bases))+
  theme_void()+
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9))
```



Cette carte de chaleur représente les saisies par des ronds rouges transparents. Plus une zone est couverte par des points, plus l'intensité du rouge augmente. \newpage

## Représentation des saisies par statut

```{r}
observations_statut <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  filter(!is.na(statut_LR))
```

```{r , fig.width = 6.5 , fig.height = 4}
ggplot(observations_statut) +
  geom_sf(aes(geometry = geom, color = statut_LR), lwd = 0.5, alpha = 0.2, size = 1.5, shape = 19) +
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5) +
  scale_color_manual(values = colors_statut, name = "Statuts espèces") +
  labs(title = paste("Représentation des saisies par statuts \nde",params$annee_debut,"à",params$annee_fin,nom_bases)) +
  theme_void() +
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9) )
```


Cette carte de chaleur représente les saisies par des ronds, la couleur est fonction du statut de l'espèce. Ici, les trois statuts sont représentés. L'intensité de la couleur gradue le nombre de saisies sur le secteur concerné. \newpage

```{r}
observations_statut_normale <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>% 
  filter(statut_LR=="normale")
```

```{r , fig.width = 6.5 , fig.height = 4}
ggplot(observations_statut_normale) +
  geom_sf(aes(geometry = geom, color = statut_LR), lwd = 0.5, alpha = 0.2, size = 1.5, shape = 19) +
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5) +
  scale_color_manual(values = colors_statut, name = "Statut espèces") +
  labs(title = paste("Représentation des saisies des espèces normales \nde",params$annee_debut,"à",params$annee_fin,nom_bases)) +
  theme_void() +
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9) )
```


Cette carte de chaleur représente les saisies des espèces dites "normales". L'intensité de la couleur gradue le nombre de saisies sur le secteur concerné.

```{r}
observations_statut_menacee <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  filter(statut_LR=="menacée")
```

```{r , fig.width = 6.5 , fig.height = 4}
ggplot(observations_statut_menacee) +
  geom_sf(aes(geometry = geom, color = statut_LR), lwd = 0.5, alpha = 0.2, size = 1.5, shape = 19) +
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5) +
  scale_color_manual(values = colors_statut, name = "Statut espèces") +
  labs(title = paste("Représentation des saisies des espèces menacées \nde",params$annee_debut,"à",params$annee_fin,nom_bases)) +
  theme_void() +
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9) )
```


Cette carte de chaleur représente les saisies des espèces dites "menacées". L'intensité de la couleur gradue le nombre de saisies sur le secteur concerné.

```{r}
observations_statut_envahissante <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>%
  filter(statut_LR=="envahissante")
```

```{r , fig.width = 6.5 , fig.height = 4}
ggplot(observations_statut_envahissante) +
  geom_sf(aes(geometry = geom, color = statut_LR), lwd = 0.5, alpha = 0.2, size = 1.5, shape = 19) +
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5) +
  scale_color_manual(values = colors_statut, name = "Statut espèces") +
  labs(title = paste("Représentation des saisies des espèces envahissantes \nde",params$annee_debut,"à",params$annee_fin,nom_bases)) +
  theme_void() +
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9) )
```


Cette carte de chaleur représente les saisies des espèces dites "envahissante". L'intensité de la couleur gradue le nombre de saisies sur le secteur concerné.

## Représentation des saisies sur les espèces protégées

```{r}
observations_espece_pro <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin)
```

```{r , fig.width = 6.5 , fig.height = 4}
ggplot(observations_espece_pro) +
  geom_sf(aes(geometry = geom, color = espece_pro), lwd = 0.5, alpha = 0.2, size = 1.5, shape = 19) +
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5) +
  scale_color_manual(values = colors_pro, name = "Réglementation") +
  labs(title = paste("Représentation des saisies sur les espèces protégées ou non \nde",params$annee_debut,"à",params$annee_fin,nom_bases)) +
  theme_void() +
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9) )
```


Cette carte de chaleur représente les saisies par des ronds, la couleur est fonction de la réglementation de l'espèce. L'intensité de la couleur gradue le nombre de saisies sur le secteur concerné. \newpage

```{r}
observations_espece_pro_seulement <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>% 
  filter(espece_pro=="protégée")
```

```{r , fig.width = 6.5 , fig.height = 4}
ggplot(observations_espece_pro_seulement) +
  geom_sf(aes(geometry = geom, color = espece_pro), lwd = 0.5, alpha = 0.2, size = 1.5, shape = 19) +
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5) +
  scale_color_manual(values = colors_pro, name = "Réglementation") +
  labs(title = paste("Représentation des saisies sur les espèces protégées \nde",params$annee_debut,"à",params$annee_fin,nom_bases)) +
  theme_void() +
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9) )
```


Cette carte de chaleur représente les saisies des espèces protégées. L'intensité de la couleur gradue le nombre de saisies sur le secteur concerné.

```{r}
observations_espece_non_pro <- OISON_PMC %>% 
  filter(annee >= params$annee_debut & annee <= params$annee_fin) %>% 
  filter(espece_pro=="non protégée")
```

```{r , fig.width = 6.5 , fig.height = 4}
ggplot(observations_espece_non_pro) +
  geom_sf(aes(geometry = geom, color = espece_pro), lwd = 0.5, alpha = 0.2, size = 1.5, shape = 19) +
  geom_sf(data = departements, fill = NA, color = "black", lwd = 0.5) +
  scale_color_manual(values = colors_pro, name = "Réglementation") +
  labs(title = paste("Représentation des Saisies des espèces non protégées \nde",params$annee_debut,"à",params$annee_fin,nom_bases)) +
  theme_void() +
  theme(text = element_text(size = 9),
      plot.title = element_text(size = 9))
```


Cette carte de chaleur représente les saisies des espèces non protégées. L'intensité de la couleur gradue le nombre de saisies sur le secteur concerné.

\newpage

# Annexes

## Annexe 1 : Explications des statuts dans les listes rouges

-   Les espèces dites "normales" appartiennent à la catégorie "Autres catégories".

-   Les espèces dites "menacées" appartiennent à la catégorie "Espèces menacées de disparition en métropole" ou "Espèces éteintes".

-   Les espèces dites "envahissantes" appartiennent à la liste des espèces envahissantes françaises.

```{r, fig.align='center', out.width="50%"}
knitr::include_graphics("../assets/Categories_LR.png")
```


```{r , fig.width = 6 , fig.height = 3.5, include = FALSE}
# POUR CHARGER CETTE PARTIE : include = TRUE
cat("## Annexe 2 : Nombre de saisies par observateur par département")

observateurs_noms_tableau <- OISON_PMC %>% 
  filter(annee == params$annee_fin) %>%
  st_set_geometry(NULL) %>% 
  select(annee, INSEE_DEP, Observateur) %>%
  # Compter le nombre d'observations par observateur et département
  group_by(annee, INSEE_DEP, Observateur) %>%
  summarise(nombre_observations = n(), .groups = 'drop') %>%
  # Trouver le maximum de nombre d'observations par observateur
  group_by(annee, Observateur) %>%
  filter(nombre_observations == max(nombre_observations)) %>%
  ungroup() %>%
  # Déduire le département avec le maximum d'observations pour chaque observateur
  group_by(annee, INSEE_DEP, Observateur) %>%
  summarise(nombre_observations=n(), .groups = 'drop') %>%
  # Arrange par département
  arrange(INSEE_DEP) %>% 
  # Garder que les colonnes
  select(Observateur,INSEE_DEP)


  
flextable(observateurs_noms_tableau) %>%
  set_header_labels(
    INSEE_DEP = "Département",
    `Observateur` = "Nom Observateur"
  ) %>%
  theme_vanilla() %>%
  color(part = "header", color = "white") %>%
  bg(part = "header", bg = "#333333") %>%
  bold(part = "header") %>%
  set_caption(caption = paste("Noms des observateurs avec leur département où ils saisissent le plus sur l'année",params$annee_fin,nom_bases)) %>% 
  set_table_properties(width = 0.5, layout = "autofit") %>% 
  fontsize(part="all",size=7) %>%
  
autofit()
```
